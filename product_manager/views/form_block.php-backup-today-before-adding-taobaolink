<?php
header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
session_start();
$curr_page=$p;
$next_page_link=$product_manager_url.'index.php?cat_id='.$cat_id.'&p='.($curr_page+1).'&non_empty_attribute='.$non_empty_attribute;
?>
<div id="container" class="ltr">
	<!-- <h1 id="logo">
		 <div style="font-size:20px;padding: 10px 10px;">1661 USA.com</div>
	</h1> -->
	
	<form id="form2" name="form2" class="wufoo topLabel page1" accept-charset="UTF-8" autocomplete="off" enctype="multipart/form-data" method="post" novalidate="" action="">
  
<header id="header" class="info">
	<h2>Price Research Form / 价格调查表</h2>
	<div></div>
	
</header>



<ul id="main_form_ul" style="margin: 0 40px;">
	<li class="main_form_li">
		<!-- <label class="desc" id="top">Product Name</label> -->
		<div>
			<span id="name"><?php echo $product->getName();?></span>
			<span id="product_id" style="display:none"><?php echo $product->getId();?></span>
		</div>

		<a href="#" id="search_on_amazon">Amazon</a>
		<a href="#" id="search_on_google">Google</a>
		<a href="#" id="search_on_walmart">Walmart</a>
		<a href="#" id="search_on_target">Target</a>
		<?php 
			// $price=(!is_null($product->getSpecialPrice())&&!empty($product->getSpecialPrice()))?$product->getSpecialPrice():$product->getPrice();
			$price=$product->getFinalPrice();
			$price=number_format($price,2);
		?>
		<a href="#" id="search_on_ipz" style="color:black;">1661USA ($<?php echo $price;?>)</a>
	</li>

	<li class="main_form_li" style="color: grey;
    background-color: rgba(202, 202, 202, 0.35);">
		<!--<label class="desc" style="color:grey;">Product Sku</label>-->
		<div>
			<span id="sku" style="color:grey;"><?php echo $product->getSku();?></span>
		</div>
	</li>
	
	<li class="main_form_li">
		<!--<label class="desc">Product Image</label>-->
		<div>
			<?php
	// var_dump($product);

			$image_external_url=$product->getData('image_external_url');
            $thumbnail=$product->getThumbnail();
            // if (!is_null($image_external_url)){
	            // echo '<img width="125px" src="'.$image_base_url.'media/catalog/product'.$image_external_url.'">';
            if (!is_null($thumbnail) && $thumbnail!='no_selection'){
	            echo '<img width="125px" src="'.$image_base_url.'media/catalog/product'.$thumbnail.'">';
            }else{
            	echo 'No image';
            }
            // var_dump($product->getData('price_wholefood'));
            ?>
		</div>
	</li>
</ul>



<?php
	// require_once 'setting_manager.php';
	//-------------------------------------------------------------
	$setting=new setting_manager("database/setting.txt");
	
	$allowed_competitors=$setting->get_allowed_competitor_array();
	if (is_null($allowed_competitors) || !is_array($allowed_competitors)){
		echo 'Cant read settings. or setting.txt is empty. no allowed competitors found. Exiting...';
		exit;
	}

	// $result=$setting->addCompetitor("100pm");

	// var_dump($result);//true
	$attributes=array();
	foreach ($allowed_competitors as $competitor) {
		// var_dump($competitor);
		//------------put in price attributes------------------
		// $exceptions=array("amazon","jd","taobao","tmall");//1661usa
		$exceptions=array();
		if (in_array($competitor, $exceptions)){
			$price_attribute_code=$competitor;
			$attributes[$competitor]['price']=$product->getData($price_attribute_code);
			// var_dump($price_attribute_code);
		}else{
			$price_attribute_code="price_".$competitor;
			// var_dump($price_attribute_code);
			$attributes[$competitor]['price']=$product->getData($price_attribute_code);
		}
		//------------put in url attributes------------------
		$url_attribute_code="url_".$competitor;
		$attributes[$competitor]['url']=$product->getData($url_attribute_code);
	}
// echo '<pre>';
// var_dump($attributes);
// echo '</pre>';
	// return;
	//-------------------------------------------------------------
/*	$attributes=array("url_amazon"=>$product->getData('url_amazon'),
						"url_jd"=>$product->getData('url_jd'),
						"url_taobao"=>$product->getData('url_taobao'),
						"url_tmall"=>$product->getData('url_tmall'),
						"price_amazon"=>$product->getData('amazon'),
						"price_jd"=>$product->getData('jd'),
						"price_taobao"=>$product->getData('taobao'),
						"price_tmall"=>$product->getData('tmall')
						);
*/


?>	
<ul id="main_form_ul_part_b">
		

<!-- Amazon part -->
<?php

function printCompetitorLinkAndPriceLi($all_allowed_info,$competitor,$is_admin){
	$this_competitor_info=$all_allowed_info[$competitor];
	$price=$this_competitor_info['price'];
	$url=$this_competitor_info['url'];

	if ($is_admin || empty($url)){
		echo '<li id="fo2li119" class="notranslate main_form_li" style="padding:0">
		<label class="desc" id="title119" for="Field119" style="padding: 4px 1% 4px 1%;">
			'.$competitor.' <span style="color:rgba(128, 128, 128, 0.45);"> Url / 产品链接 </span>
		</label>
		<div style="width: 90%;padding: 0 1%;">
			<input id="'.'url_'.$competitor.'" name="'.'url_'.$competitor.'" type="url" class="field text large" value="'.$url.'" maxlength="255" tabindex="1"   style="cursor: auto;">
		</div>
	</li>';
	}
	// now print price:
	if ($is_admin || empty($price) || $price=="RMB" || $price=="USD"){		
		echo '<li id="fo2li102" class="notranslate  main_form_li"  style="padding:0">
	<label class="desc" id="title109" style="padding: 4px 1% 4px 1%;">
		'.$competitor.' <span style="color:rgba(128, 128, 128, 0.45);"> Price / 价格 </span>
	</label>
	<table>
		<tr>
			
			<td>
				<div>
					<select id="currency_'.$competitor.'" name="currency_'.$competitor.'" class="field select small"  tabindex="3">
							<option value="USD" ';
							if (substr($price,0,3)=="USD") {
									echo 'selected'; 
									$price=substr($price,3);
								}
							echo '>USD</option>
							<option value="RMB" ';
							if (substr($price,0,3)=="RMB") {
									echo 'selected'; 
									$price=substr($price,3);
								}
							echo '>RMB</option>
					</select>
				</div>
			</td>
			<td>
				<div>
					<input id="price_'.$competitor.'" name="price_'.$competitor.'" type="text" class="field text small" value="'.$price.'" maxlength="255" tabindex="4"  >
				</div>
			</td>
		</tr>
	</table>
</li>';
	}
}
//---------------------------------------------
echo '<div id="floating_nav" style="position:fixed;top:50;left:15;padding:15px; box-shadow: 4px 4px 4px rgba(136, 136, 136, 0.27);    border: rgba(95, 95, 126, 0.21) 1px solid;    background: -webkit-gradient(linear, left top, left bottom, from(rgba(0, 188, 212, 0.18)), to(rgba(138, 158, 77, 0.58))) fixed !important;border-radius:5px">';
	echo '<ul>';
		echo '<li><a href="#top" style="color:black;">TOP</a></li>';
		foreach ($allowed_competitors as $competitor) {
			echo '<li>';
			echo '<a style="color:black" href="#'.$competitor.'" class="no_match">[x]</a>';
			echo '<a style="color:black;display:none" href="#'.$competitor.'" class="confirm_no_match">[&#10004;]</a>';
			echo '&nbsp;';
			echo '<a href="#'.$competitor.'">'.$competitor.'</a></li>';
		}
		echo '<li><a href="#i_recommend" style="color:black;
    font-weight: 400;
    font-style: italic;
    font-variant: small-caps;">I recommend</a></li>';
	echo '</ul>';

	echo '<li><a href="'.$next_page_link.'" style="color:black;">Next</a></li>';
echo '</div>';
//---------------------------------------------
// var_dump($attributes);
foreach ($allowed_competitors as $competitor) {
	// printCompetitorLinkAndPriceLi($attributes,'amazon',$is_admin);
	echo '<div id="'.$competitor.'" style="border: 1px solid #c4c4c4;background-color: #efefef;margin: 0px 30px;padding: 5px;   ">';
	printCompetitorLinkAndPriceLi($attributes,$competitor,$is_admin);//the same attribute array contains every  competitor as key
	echo '</div>';
}

$i_recommend=$product->getData('i_recommend');
$checked_or_not=($i_recommend==="1")?"checked":"";
// var_dump($checked_or_not);
echo '<div style="margin:30px;"> 
		  <input type="checkbox" id="i_recommend" '.$checked_or_not.'><span style="    padding: 0 15px;">I RECOMMEND this product because it is good brand and has significant cheaper price on 1661USA.com. </span>
	  </div>';
?>
	
	<li class="buttons ">
		<div>
			<!-- <input id="saveForm" name="saveForm" class="btTxt submit" type="submit" value="Submit" onmousedown="doSubmitEvents();"> -->
			<!-- <input id="next" name="next" class="btTxt submit" type="submit" value="next_page"> -->
			<?php 
				// $product_manager_url=$base_url.'alice/product_manager/';//overwirte the one in config.php
				?>
			<span> <a style="background: #DEDEDE;text-decoration: none;float: right;color: black;padding: 10px 5px;border: 1px solid black;" 
    					href="<?php echo $next_page_link;?>">Next Product / 下一个产品</a></span>
		</div>
	</li>
</ul>
</form>

 
</div><!--container-->

<script src="js/test.js"></script>


<script type="text/javascript">
$(document).ready(function(){
	//------------for search on Amazon conveniently---------
		$('#search_on_amazon').click(function(){
			var name=$('#name').html();
			if (name){//if string is not empty
				// alert($name);
				window.open("http://www.amazon.com/s/ref=nb_sb_noss_2?url=search-alias%3Daps&field-keywords="+encodeURIComponent(name));
			}else{
				alert('Name cannot be empty');
			}
		});
		//------------for search on Google conveniently---------
		$('#search_on_google').click(function(){
			var name=$('#name').html();
			if (name){//if string is not empty
				// alert($name);
				window.open("https://www.google.com/search?q="+encodeURIComponent(name));
			}else{
				alert('Name cannot be empty');
			}
		});
		//------------for search on Walmart conveniently---------
		$('#search_on_walmart').click(function(){
			var name=$('#name').html();
			if (name){//if string is not empty
				// alert($name);
				window.open("http://www.walmart.com/search/?query="+encodeURIComponent(name));
			}else{
				alert('Name cannot be empty');
			}
		});
		//------------for search on Target conveniently---------
		$('#search_on_target').click(function(){
			var name=$('#name').html();
			if (name){//if string is not empty
				// alert($name);
				window.open("http://www.target.com/s?searchTerm="+encodeURIComponent(name)+"&category=0%7CAll%7Cmatchallpartial%7Call+categories");
			}else{
				alert('Name cannot be empty');
			}
		});
		//------------for product page on ipz conveniently---------
		$('#search_on_ipz').click(function(){
			var id=$('#product_id').html();
			if (id){//if string is not empty
				// alert($name);
				window.open("https://www.1661usa.com/en/catalog/product/view/id/"+id);
			}else{
				alert('product id cannot be empty');
			}
		});




		//==================I recommend=====================
		$('#i_recommend').change(function(){
	    	// alert($(this).parents('form').find('#sku').text());
		    var element = this;
		    if (this.checked){
		    	// alert('checked');
		    	$(element).parent('div').css('background-color', 'white');//remove any color
				$.ajax(
				   	{
				   		url: "api.php",
				   		type:"GET",
				   		dataType: 'json', // jQuery will parse the response as JSON
				   		data: {"class":"i_recommend","sku":$(element).parents('form').find('#sku').text(),"new_value":1,"worker_id":$('#session_user_id').text()},
				    	success: function(result){
				    		console.log(result);
				    		if (result['status']=="error"){
				    			$(element).parent('div').css('background-color', 'rgb(255, 152, 145)');//red
				    			alert(result['error_details']);
				    		}else{
				    			$(element).parent('div').css('background-color', '#D8FFDA');//green
				    		}
				    	},
				    	error: function(jqXHR, textStatus, errorThrown) {
			        		// report error
		    				console.log('ajax request failed: pls check your php file ');
			    			var error = jQuery.parseJSON(jqXHR.responseText);
							alert(error.errors.message);
							$(element).parent('div').css('background-color', 'rgb(255, 152, 145)');//red
			    		}
					}
				);
		    }else{
		    	// alert('unchecked');
		    	$(element).parent('div').css('background-color', 'white');//remove any color
				$.ajax(
				   	{
				   		url: "api.php",
				   		type:"GET",
				   		dataType: 'json', // jQuery will parse the response as JSON
				   		data: {"class":"i_recommend","sku":$(element).parents('form').find('#sku').text(),"new_value":0,"worker_id":$('#session_user_id').text()},
				    	success: function(result){
				    		console.log(result);
				    		if (result['status']=="error"){
				    			$(element).parent('div').css('background-color', 'rgb(255, 152, 145)');//red
				    			alert(result['error_details']);
				    		}else{
				    			$(element).parent('div').css('background-color', '#D8FFDA');//green
				    		}
				    	},
				    	error: function(jqXHR, textStatus, errorThrown) {
			        		// report error
		    				console.log('ajax request failed: pls check your php file ');
			    			var error = jQuery.parseJSON(jqXHR.responseText);
							alert(error.errors.message);
							$(element).parent('div').css('background-color', 'rgb(255, 152, 145)');//red
			    		}
					}
				);
		    }
	    	
  		});
});

</script>
<script type="text/javascript">
$(document).ready(function(){
	$('#main_form_ul_part_b>div#floating_nav>ul>li>a').click(function(){
		// alert($(this).attr('href'));
		//restore border color for all div:
		$('#main_form_ul_part_b>div#floating_nav>ul>li>a').each(function(){
			var competitor_name=$(this).attr('href');
			// console.log(competitor_name);
			if (competitor_name){
				$(competitor_name).css('border-color','#c4c4c4');
			}
		});
		// highlight only selected competitor div:
		var competitor_name=$(this).attr('href');//#amazon
		// console.log(competitor_name);
		if (competitor_name){
			$(competitor_name).css('border-color','yellow');
		}
		//-----------------------------------------------
		//if the class of this element is no_match, fill in No Match:
		var className=$(this).attr('class');
		// console.log(className);//undefined or no_match
		if (className=="no_match"){//not undefined
			//-----fill in No Match to this competitor fields-----
			//console.log('no_match');
			var text_field_1_selector='#url_'+competitor_name.substring(1);//#url_amaozn
			var text_field_2_selector='#price_'+competitor_name.substring(1);//#[price_amaozn
			// console.log(text_field_2_selector);
			$(text_field_1_selector).val("No Match");
			$(text_field_2_selector).val("No Match");
			//---------------unhide confirm button-----------------
			$(this).next('.confirm_no_match').css('display','inline');
			$(this).css('display','none');
		}
		//-----------------------------------------------
		//if the class of this element is confirm_no_match, move cursor in and out fields, to make input fields update and turn green:
		var className=$(this).attr('class');
		// console.log(className);//undefined or no_match
		if (className=="confirm_no_match"){//not undefined
			//-----fill in No Match to this competitor fields-----
			//console.log('no_match');
			var text_field_1_selector='#url_'+competitor_name.substring(1);//#url_amaozn
			var text_field_2_selector='#price_'+competitor_name.substring(1);//#[price_amaozn
			// console.log(text_field_2_selector);
			$(text_field_1_selector).blur();//unfocus
			$(text_field_2_selector).blur();//unfocus
			//---------------add a confirm button-----------------
			$(this).css('display','none');
			$(this).prev('no_match').css('display','inline');
		}
	});
});

</script>
<script type="text/javascript">
	var refreshTime = 600000; // every 10 minutes in milliseconds
	// var refreshTime = 5000; // every 5 seconds in milliseconds
	window.setInterval( function() {
	    $.ajax({
	        cache: false,
	        type: "GET",
	        url: "refreshSession.php",
	        success: function(data) {
	        	console.log('refreshed session');
	        }
	    });
	}, refreshTime );

</script>


